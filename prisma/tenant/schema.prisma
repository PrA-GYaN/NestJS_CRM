// Tenant Database Schema
// Contains ALL tenant-specific operational data
// Each tenant has their own database with this schema

generator client {
  provider = "prisma-client-js"
  output   = "../../node_modules/@prisma/tenant-client"
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
  url      = env("TENANT_DATABASE_URL")
}

// ============================================
// USER & ACCESS CONTROL MODULE
// ============================================

enum UserStatus {
  Active
  Inactive
}

model User {
  id        String     @id @default(uuid())
  tenantId  String
  name      String
  email     String
  password  String     // Hashed
  roleId    String
  status    UserStatus @default(Active)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  role              Role            @relation(fields: [roleId], references: [id], onDelete: Cascade)
  assignedLeads     Lead[]          @relation("AssignedUser")
  assignedTasks     Task[]          @relation("AssignedUser")
  staffAppointments Appointment[]   @relation("StaffAppointments")
  instructorClasses Class[]         @relation("Instructor")
  notifications     Notification[]
  activityLogs      ActivityLog[]

  @@unique([tenantId, email])
  @@index([tenantId, email])
  @@index([tenantId, roleId])
  @@map("users")
}

model Role {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  isAdmin     Boolean  @default(false) // Admin override flag
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  users           User[]
  rolePermissions RolePermission[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("roles")
}

model Permission {
  id          String   @id @default(uuid())
  tenantId    String
  name        String   // Format: "module:action" e.g., "leads:create", "students:read"
  module      String   // e.g., "leads", "students", "users"
  action      String   // e.g., "create", "read", "update", "delete", "export"
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  rolePermissions RolePermission[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, module])
  @@map("permissions")
}

model RolePermission {
  id           String   @id @default(uuid())
  tenantId     String
  roleId       String
  permissionId String
  createdAt    DateTime @default(now())

  role       Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([tenantId])
  @@map("role_permissions")
}

// ============================================
// LEAD MANAGEMENT MODULE
// ============================================

enum LeadStatus {
  New
  Contacted
  Qualified
  Converted
  NotInterested
  NotReachable
}

enum Priority {
  High
  Medium
  Low
}

model Lead {
  id                 String     @id @default(uuid())
  tenantId           String
  assignedUserId     String?
  firstName          String
  lastName           String
  email              String
  phone              String?
  academicBackground String?
  studyInterests     String?
  status             LeadStatus @default(New)
  priority           Priority   @default(Medium)
  source             String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  assignedUser User?     @relation("AssignedUser", fields: [assignedUserId], references: [id], onDelete: SetNull)
  students     Student[]

  @@index([tenantId, status])
  @@index([tenantId, email])
  @@index([tenantId, assignedUserId])
  @@map("leads")
}

// ============================================
// STUDENT MANAGEMENT MODULE
// ============================================

enum StudentStatus {
  Prospective
  Enrolled
  Alumni
}

model Student {
  id                  String        @id @default(uuid())
  tenantId            String
  leadId              String?
  firstName           String
  lastName            String
  email               String
  phone               String?
  password            String?       // Hashed password for student login
  hashedPassword      String?       // Alternative field name for clarity
  isActive            Boolean       @default(true)
  emailVerified       Boolean       @default(false)
  lastLogin           DateTime?
  academicRecords     Json?         // Stores academic history
  testScores          Json?         // Stores test scores (IELTS, TOEFL, GRE, etc.)
  identificationDocs  Json?         // Passport, National ID details
  status              StudentStatus @default(Prospective)
  priority            Priority      @default(Medium)
  profileCompleteness Int?          @default(0) // 0-100%
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt

  lead                Lead?                 @relation(fields: [leadId], references: [id], onDelete: SetNull)
  documents           StudentDocument[]
  appointments        Appointment[]
  classEnrollments    ClassEnrollment[]
  testAssignments     TestAssignment[]
  visaApplications    VisaApplication[]
  courseApplications  CourseApplication[]
  payments            Payment[]
  studentServices     StudentService[]
  studentNotifications StudentNotification[]

  @@index([tenantId, status])
  @@index([tenantId, email])
  @@index([tenantId, leadId])
  @@index([tenantId, isActive])
  @@map("students")
}

enum DocumentType {
  Passport
  Transcript
  VisaForm
  Photo
  Certificate
  OfferLetter
  AcademicDocument
  FinancialDocument
  LanguageTestResult
  RecommendationLetter
  Other
}

enum DocumentVerificationStatus {
  Pending
  Verified
  Rejected
  Expired
}

model StudentDocument {
  id                   String                      @id @default(uuid())
  tenantId             String
  studentId            String
  documentType         DocumentType
  filePath             String
  fileName             String?
  fileSize             Int?                        // Size in bytes
  version              Int                         @default(1)
  verificationStatus   DocumentVerificationStatus  @default(Pending)
  verifiedBy           String?                     // User ID who verified
  verificationDate     DateTime?
  verificationNotes    String?
  rejectionReason      String?
  expiryDate           DateTime?
  uploadedAt           DateTime                    @default(now())
  metadata             Json?                       // Additional document metadata

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, studentId])
  @@index([studentId])
  @@index([tenantId, verificationStatus])
  @@map("student_documents")
}

// ============================================
// COUNTRY MODULE (TENANT-SCOPED)
// ============================================

// ============================================
// COURSE APPLICATION MODULE
// ============================================

enum ApplicationStatus {
  Draft
  Submitted
  UnderReview
  Shortlisted
  OfferReceived
  Accepted
  Rejected
  Withdrawn
}

model CourseApplication {
  id                String            @id @default(uuid())
  tenantId          String
  studentId         String
  courseId          String
  universityId      String
  status            ApplicationStatus @default(Draft)
  applicationDate   DateTime?
  submissionDate    DateTime?
  offerReceivedDate DateTime?
  offerExpiryDate   DateTime?
  decisionDate      DateTime?
  intakePeriod      String?           // e.g., "Fall 2024", "January 2025"
  applicationFee    Decimal?          @db.Decimal(10, 2)
  offerDocumentPath String?           // Path to offer letter
  rejectionReason   String?
  notes             Json?             // Additional notes and updates
  assignedTo        String?           // Consultant handling the application
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  student    Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  course     Course     @relation(fields: [courseId], references: [id], onDelete: Cascade)
  university University @relation(fields: [universityId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, studentId])
  @@index([tenantId, status])
  @@index([studentId, status])
  @@map("course_applications")
}

// ============================================
// STUDENT NOTIFICATION MODULE
// ============================================

enum StudentNotificationType {
  Application
  Document
  Visa
  Payment
  Appointment
  Task
  General
  Message
}

model StudentNotification {
  id         String                   @id @default(uuid())
  tenantId   String
  studentId  String
  type       StudentNotificationType
  title      String
  message    String
  isRead     Boolean                  @default(false)
  readAt     DateTime?
  actionUrl  String?                  // Optional link for action
  metadata   Json?                    // Additional context
  createdAt  DateTime                 @default(now())

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([tenantId, studentId])
  @@index([tenantId, studentId, isRead])
  @@index([studentId, createdAt])
  @@map("student_notifications")
}

// ============================================
// COUNTRY MODULE (TENANT-SCOPED)
// ============================================

model Country {
  id        String   @id @default(uuid())
  tenantId  String
  name      String
  code      String   // ISO country code (e.g., US, UK, CA)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  universities University[]
  visaTypes    VisaType[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([tenantId, isActive])
  @@map("countries")
}

// ============================================
// UNIVERSITY & COURSE MODULE
// ============================================

model University {
  id          String   @id @default(uuid())
  tenantId    String
  countryId   String
  name        String
  ranking     Int?
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  country            Country             @relation(fields: [countryId], references: [id], onDelete: Cascade)
  courses            Course[]
  commissions        Commission[]
  courseApplications CourseApplication[]

  @@index([tenantId])
  @@index([tenantId, countryId])
  @@index([countryId])
  @@map("universities")
}

model Course {
  id            String   @id @default(uuid())
  tenantId      String
  universityId  String
  name          String
  fees          Decimal  @db.Decimal(10, 2)
  duration      String?  // e.g., "2 years", "6 months"
  requirements  Json?    // Entry requirements
  intakePeriods Json?    // Available intake periods
  deadlines     Json?    // Application deadlines
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  university         University          @relation(fields: [universityId], references: [id], onDelete: Cascade)
  classes            Class[]
  courseApplications CourseApplication[]

  @@index([tenantId])
  @@index([tenantId, universityId])
  @@index([universityId])
  @@map("courses")
}

// ============================================
// CLASS & TEST MODULE
// ============================================

enum ClassLevel {
  Beginner
  Intermediate
  Advanced
}

model Class {
  id           String     @id @default(uuid())
  tenantId     String
  courseId     String?
  level        ClassLevel
  schedule     Json       // Class schedule with dates and times
  instructorId String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  course      Course?           @relation(fields: [courseId], references: [id], onDelete: SetNull)
  instructor  User?             @relation("Instructor", fields: [instructorId], references: [id], onDelete: SetNull)
  enrollments ClassEnrollment[]

  @@index([tenantId])
  @@index([tenantId, instructorId])
  @@map("classes")
}

enum EnrollmentStatus {
  Active
  Completed
  Dropped
}

model ClassEnrollment {
  id        String           @id @default(uuid())
  classId   String
  studentId String
  status    EnrollmentStatus @default(Active)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  class   Class   @relation(fields: [classId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@unique([classId, studentId])
  @@index([studentId])
  @@map("class_enrollments")
}

enum TestType {
  IELTS
  TOEFL
  GRE
  GMAT
  SAT
  Other
}

model Test {
  id          String   @id @default(uuid())
  name        String
  type        TestType
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  assignments TestAssignment[]

  @@map("tests")
}

enum TestAssignmentStatus {
  Pending
  Completed
  Graded
}

model TestAssignment {
  id        String               @id @default(uuid())
  testId    String
  studentId String
  status    TestAssignmentStatus @default(Pending)
  score     Decimal?             @db.Decimal(5, 2)
  createdAt DateTime             @default(now())
  updatedAt DateTime             @updatedAt

  test    Test    @relation(fields: [testId], references: [id], onDelete: Cascade)
  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([testId])
  @@map("test_assignments")
}

// ============================================
// APPOINTMENT MODULE
// ============================================

enum DayOfWeek {
  Monday
  Tuesday
  Wednesday
  Thursday
  Friday
  Saturday
  Sunday
}

enum AppointmentStatus {
  Pending      // Initial status when student creates request
  Booked       // Approved by staff
  Rejected     // Declined by staff
  Scheduled    // Legacy status (for backward compatibility)
  Completed
  Cancelled
  NoShow
}

enum AppointmentRequestedBy {
  Student
  Staff
  System
}

model TenantWorkingHours {
  id        String    @id @default(uuid())
  tenantId  String
  dayOfWeek DayOfWeek
  isOpen    Boolean   @default(true)
  openTime  String?   // Format: "09:00" (24-hour format), nullable when closed
  closeTime String?   // Format: "17:00" (24-hour format), nullable when closed
  timezone  String    // e.g., "America/New_York", "Asia/Kathmandu"
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([tenantId, dayOfWeek])
  @@index([tenantId, isActive])
  @@index([tenantId, dayOfWeek, isOpen])
  @@map("tenant_working_hours")
}

model Appointment {
  id          String                  @id @default(uuid())
  tenantId    String
  studentId   String
  staffId     String // Assigned staff member
  
  // Scheduling details
  scheduledAt DateTime // Appointment start time (UTC)
  duration    Int      @default(60) // Duration in minutes (max 120)
  endTime     DateTime // Calculated: scheduledAt + duration
  timezone    String   @default("UTC") // Timezone for display
  
  // Appointment details
  purpose     String?
  notes       String? // Additional notes from student
  staffNotes  String? // Staff internal notes
  
  // Status management
  status      AppointmentStatus       @default(Pending)
  requestedBy AppointmentRequestedBy  @default(Student)
  
  // Approval workflow
  requestedAt       DateTime  @default(now())
  approvedAt        DateTime?
  approvedBy        String? // Staff user ID who approved
  rejectedAt        DateTime?
  rejectedBy        String? // Staff user ID who rejected
  rejectionReason   String?
  
  // Cancellation
  cancelledAt       DateTime?
  cancelledBy       String? // User ID who cancelled
  cancellationReason String?
  
  // Completion
  completedAt  DateTime?
  outcomeNotes String? // Post-appointment notes
  
  // Metadata
  version   Int      @default(1) // Optimistic locking
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Reminder tracking
  reminder24hSent Boolean @default(false)
  reminder1hSent  Boolean @default(false)

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  staff   User    @relation("StaffAppointments", fields: [staffId], references: [id], onDelete: Cascade)

  @@index([tenantId, status])
  @@index([tenantId, studentId, status])
  @@index([tenantId, staffId, status])
  @@index([tenantId, staffId, scheduledAt])
  @@index([tenantId, scheduledAt])
  @@index([status, scheduledAt])
  @@index([tenantId, status, scheduledAt])
  @@map("appointments")
}

// ============================================
// TASK & WORKFLOW MODULE
// ============================================

enum TaskStatus {
  Pending
  InProgress
  Completed
  Cancelled
}

enum RelatedEntityType {
  Student
  Lead
  Visa
  Service
  Appointment
}

model Task {
  id                String            @id @default(uuid())
  tenantId          String
  assignedTo        String
  relatedEntityType RelatedEntityType
  relatedEntityId   String
  title             String
  description       String?
  status            TaskStatus        @default(Pending)
  priority          Priority          @default(Medium)
  dueDate           DateTime?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt

  assignedUser User @relation("AssignedUser", fields: [assignedTo], references: [id], onDelete: Cascade)

  @@index([tenantId, assignedTo])
  @@index([tenantId, status])
  @@index([tenantId, relatedEntityType, relatedEntityId])
  @@map("tasks")
}

// ============================================
// VISA PROCESSING MODULE
// ============================================

enum VisaStatus {
  Pending
  Submitted
  Approved
  Rejected
  UnderReview
}

model VisaType {
  id          String   @id @default(uuid())
  tenantId    String
  countryId   String
  name        String   // e.g., "Student Visa", "Work Visa", "Tourist Visa"
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  country      Country           @relation(fields: [countryId], references: [id], onDelete: Cascade)
  workflows    VisaWorkflow[]
  applications VisaApplication[]

  @@unique([tenantId, countryId, name])
  @@index([tenantId])
  @@index([tenantId, countryId])
  @@index([countryId])
  @@map("visa_types")
}

model VisaWorkflow {
  id          String   @id @default(uuid())
  tenantId    String
  visaTypeId  String
  name        String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  visaType VisaType           @relation(fields: [visaTypeId], references: [id], onDelete: Cascade)
  steps    VisaWorkflowStep[]

  @@index([tenantId])
  @@index([tenantId, visaTypeId])
  @@index([visaTypeId])
  @@map("visa_workflows")
}

model VisaWorkflowStep {
  id                   String   @id @default(uuid())
  tenantId             String
  workflowId           String
  name                 String
  description          String?
  stepOrder            Int
  requiresDocument     Boolean  @default(false)
  isActive             Boolean  @default(true)
  expectedDurationDays Int?     // SLA in days
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  workflow VisaWorkflow @relation(fields: [workflowId], references: [id], onDelete: Cascade)

  @@unique([workflowId, stepOrder])
  @@index([tenantId])
  @@index([tenantId, workflowId])
  @@index([workflowId])
  @@map("visa_workflow_steps")
}

model VisaApplication {
  id                 String     @id @default(uuid())
  tenantId           String
  studentId          String
  visaTypeId         String
  destinationCountry String     // Kept for backward compatibility
  status             VisaStatus @default(Pending)
  currentStepId      String?    // Current workflow step
  submissionDate     DateTime?
  decisionDate       DateTime?
  notes              String?
  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  student   Student        @relation(fields: [studentId], references: [id], onDelete: Cascade)
  visaType  VisaType       @relation(fields: [visaTypeId], references: [id], onDelete: Restrict)
  documents VisaDocument[]

  @@index([tenantId])
  @@index([tenantId, studentId])
  @@index([tenantId, visaTypeId])
  @@index([studentId])
  @@index([visaTypeId])
  @@index([status])
  @@map("visa_applications")
}

model VisaDocument {
  id                String       @id @default(uuid())
  tenantId          String
  visaApplicationId String
  documentType      DocumentType
  filePath          String
  uploadedAt        DateTime     @default(now())

  visaApplication VisaApplication @relation(fields: [visaApplicationId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([tenantId, visaApplicationId])
  @@index([visaApplicationId])
  @@map("visa_documents")
}

// ============================================
// FILE UPLOAD & STORAGE MODULE
// ============================================

enum FileCategory {
  StudentDocument
  VisaDocument
  CourseDocument
  General
}

model FileUpload {
  id               String       @id @default(uuid())
  tenantId         String
  studentId        String?
  visaApplicationId String?
  courseId         String?
  category         FileCategory
  originalFileName String
  storedFileName   String
  filePath         String       // Relative path from root
  fileSize         Int          // Size in bytes
  mimeType         String
  uploadedBy       String?      // User ID
  uploadedAt       DateTime     @default(now())
  metadata         Json?        // Additional metadata

  @@index([tenantId])
  @@index([tenantId, studentId])
  @@index([tenantId, visaApplicationId])
  @@index([tenantId, category])
  @@map("file_uploads")
}

// ============================================
// SERVICES & COMMISSIONS MODULE
// ============================================

model Service {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  price       Decimal  @db.Decimal(10, 2)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  commissions     Commission[]
  payments        Payment[]
  studentServices StudentService[]

  @@index([tenantId])
  @@map("services")
}

model StudentService {
  id         String   @id @default(uuid())
  tenantId   String
  studentId  String
  serviceId  String
  assignedAt DateTime @default(now())
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  student Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  service Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@unique([studentId, serviceId])
  @@index([tenantId, studentId])
  @@index([tenantId, serviceId])
  @@map("student_services")
}

enum CommissionStatus {
  Pending
  Paid
  Cancelled
}

model Commission {
  id           String           @id @default(uuid())
  serviceId    String
  universityId String
  amount       Decimal          @db.Decimal(10, 2)
  status       CommissionStatus @default(Pending)
  paidDate     DateTime?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  service    Service    @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  university University @relation(fields: [universityId], references: [id], onDelete: Cascade)

  @@index([serviceId])
  @@index([universityId])
  @@index([status])
  @@map("commissions")
}

// ============================================
// CONTENT MANAGEMENT MODULE (CMS)
// ============================================

enum ContentStatus {
  Draft
  Published
  Unpublished
}

model BlogPost {
  id            String        @id @default(uuid())
  tenantId      String
  title         String
  slug          String
  excerpt       String?
  content       String        // Main content (HTML/Markdown)
  featuredImage String?       // Image URL or path
  author        String?       // Author name
  tags          Json?         // Array of tags
  metaTitle     String?       // SEO meta title
  metaDescription String?     // SEO meta description
  status        ContentStatus @default(Draft)
  publishedAt   DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, publishedAt])
  @@map("blog_posts")
}

model FAQ {
  id         String   @id @default(uuid())
  tenantId   String
  category   String?  // FAQ category (e.g., "Visa", "Admission", "General")
  question   String
  answer     String
  sortOrder  Int      @default(0) // For custom ordering
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([tenantId])
  @@index([tenantId, category])
  @@index([tenantId, sortOrder])
  @@map("faqs")
}

model LandingPage {
  id              String        @id @default(uuid())
  tenantId        String
  title           String
  slug            String
  content         String        // Main page content (HTML/Markdown)
  heroImage       String?       // Hero/banner image
  metaTitle       String?       // SEO meta title
  metaDescription String?       // SEO meta description
  status          ContentStatus @default(Draft)
  publishedAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([tenantId, status])
  @@map("landing_pages")
}

model Scholarship {
  id              String        @id @default(uuid())
  tenantId        String
  title           String
  slug            String
  description     String
  eligibility     String?       // Eligibility criteria
  amount          Decimal?      @db.Decimal(10, 2)
  currency        String?       @default("USD")
  deadline        DateTime
  applicationUrl  String?       // External application link
  universityName  String?
  countryName     String?
  status          ContentStatus @default(Draft)
  publishedAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, deadline])
  @@map("scholarships")
}

// ============================================
// TEMPLATE & MESSAGING MODULE (PER TENANT ONLY)
// ============================================

enum TemplateType {
  Email
  SMS
}

enum TemplateStatus {
  Active
  Inactive
}

enum MessageEventType {
  LeadCreated
  LeadAssigned
  LeadConverted
  StudentCreated
  AppointmentScheduled
  AppointmentReminder
  TaskAssigned
  TaskDueReminder
  VisaWorkflowStepChanged
  DocumentRequested
  DocumentUploaded
  PaymentReceived
  PaymentDue
  PasswordReset
  WelcomeEmail
  Custom
}

model EmailTemplate {
  id          String         @id @default(uuid())
  tenantId    String         // MANDATORY - Every template belongs to ONE tenant
  name        String         // Template name (unique per tenant)
  subject     String         // Email subject line
  body        String         // Email body (HTML or plain text)
  variables   Json?          // Available variables/placeholders (e.g., ["studentName", "appointmentDate"])
  eventType   MessageEventType? // Optional event mapping
  status      TemplateStatus @default(Inactive)
  description String?        // Optional description
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  messages MessageLog[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, eventType])
  @@map("email_templates")
}

model SMSTemplate {
  id          String         @id @default(uuid())
  tenantId    String         // MANDATORY - Every template belongs to ONE tenant
  name        String         // Template name (unique per tenant)
  body        String         // SMS body text
  variables   Json?          // Available variables/placeholders
  eventType   MessageEventType? // Optional event mapping
  status      TemplateStatus @default(Inactive)
  description String?        // Optional description
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  messages MessageLog[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, eventType])
  @@map("sms_templates")
}

enum MessageStatus {
  Pending
  Sent
  Failed
  Delivered
}

model MessageLog {
  id               String            @id @default(uuid())
  tenantId         String            // MANDATORY - tenant context
  messageType      TemplateType      // Email or SMS
  emailTemplateId  String?           // Reference to email template (if email)
  smsTemplateId    String?           // Reference to SMS template (if SMS)
  recipientEmail   String?           // For email
  recipientPhone   String?           // For SMS
  subject          String?           // For email
  body             String            // Actual message sent (after variable substitution)
  variables        Json?             // Variables used in this message
  eventType        MessageEventType? // Event that triggered this message
  status           MessageStatus     @default(Pending)
  sentAt           DateTime?
  deliveredAt      DateTime?
  errorMessage     String?           // Error details if failed
  metadata         Json?             // Additional metadata
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  emailTemplate EmailTemplate? @relation(fields: [emailTemplateId], references: [id], onDelete: SetNull)
  smsTemplate   SMSTemplate?   @relation(fields: [smsTemplateId], references: [id], onDelete: SetNull)

  @@index([tenantId])
  @@index([tenantId, messageType])
  @@index([tenantId, status])
  @@index([tenantId, eventType])
  @@index([tenantId, createdAt])
  @@map("message_logs")
}

// ============================================
// PAYMENTS & NOTIFICATIONS MODULE
// ============================================

enum PaymentStatus {
  Pending
  Completed
  Failed
  Refunded
}

model Payment {
  id          String        @id @default(uuid())
  tenantId    String
  studentId   String
  serviceId   String?
  amount      Decimal       @db.Decimal(10, 2)
  status      PaymentStatus @default(Pending)
  paymentDate DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  student Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  service Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)

  @@index([tenantId, studentId])
  @@index([tenantId, status])
  @@map("payments")
}

enum NotificationType {
  Email
  SMS
  InApp
}

enum NotificationStatus {
  Sent
  Read
  Unread
}

enum NotificationEntityType {
  Task
  Appointment
  Lead
  Student
  Service
  Other
}

model Notification {
  id        String                   @id @default(uuid())
  tenantId  String
  userId    String
  type      NotificationEntityType   // Task/Appointment/etc
  message   String
  status    NotificationStatus       @default(Sent)
  metadata  Json?                    // Extra info: task title, appointment time, etc.
  readAt    DateTime?
  createdAt DateTime                 @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([tenantId, userId])
  @@index([tenantId, userId, status])
  @@index([tenantId, createdAt])
  @@map("notifications")
}

// ============================================
// AUDIT & ACTIVITY MODULE
// ============================================

enum ActivityAction {
  Created
  Updated
  Deleted
  StatusChanged
  Assigned
  Completed
  Cancelled
  Login
  Logout
  AccessDenied
}

model ActivityLog {
  id         String         @id @default(uuid())
  tenantId   String
  userId     String?
  entityType String         // Task, Appointment, Lead, Student, etc.
  entityId   String
  action     ActivityAction
  changes    Json?          // JSON diff of changes
  metadata   Json?          // Additional context
  timestamp  DateTime       @default(now())

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId, entityType, entityId])
  @@index([tenantId, userId])
  @@index([tenantId, timestamp])
  @@index([tenantId, entityType])
  @@map("activity_logs")
}
